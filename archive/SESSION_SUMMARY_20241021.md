# Session Summary - Indel Testing Project

## Repository
- GitHub: https://github.com/jargenmega/indel_testing.git

## Current Status
- Date: October 21, 2024
- All code committed and pushed to GitHub

## Key Findings

### 1. Germline Indel Comparison (compare_germline_indels.py)
**After filtering for not-difficult regions:**
- Parquet germline indels: **189,751** (24% of original 795,058)
- DeepVariant total indels: **371,755** (24% of original 1,557,716)
- Ratio: **1.96x** more indels in DeepVariant (consistent before and after filtering)

### 2. VCF Structure (explore_vcf_structure.py)
- **Mixed positions are rare**: Only 6 out of 10,000 positions have both INDELs and SNVs
- All mixed positions are **multi-allelic sites** with format like:
  - `GC → AC (SNV), G (deletion)`
  - `A → ATG (insertion), G (SNV)`
- **INFO fields**: Minimal (just PASS and RefCall flags)
- **FORMAT fields**: GT, VAF, DP, GQ, AD, PL, MID

### 3. Near_germ Analysis
- **100% of germline ALT indels** have near_germ=True
- This is expected by definition

## Files in Repository

1. **compare_germline_indels.py** - Main comparison script with not-difficult filtering
2. **explore_vcf_structure.py** - VCF structure exploration with mixed position analysis
3. **count_indels_chart.py** - Indel analysis for CRAM/BAM with visualization
4. **indel_quality_analysis.py** - Quality analysis of indel-containing reads

## Data Paths
- Parquet: `/home/ubuntu/data/teamb_indel-caller/results/sample1_indels_only.parquet`
- VCF: `/home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.vcf.gz`
- BED: `/home/ubuntu/data/reference/beds/GRCh38_difficult_comp.bed.gz`

## Next Steps
1. Create filtered VCF with only indels in not-difficult regions (to avoid slow BED loading)
2. Compare actual positions between parquet and DeepVariant
3. Analyze why DeepVariant finds ~2x more indels

## Performance Note
- BED file loading takes significant time (4.7M regions)
- Consider pre-filtering VCF to speed up subsequent analyses



Example vcf to parquet output:
(base) ubuntu@ip-172-31-69-189:~/projects/indel_testing$ python vcf_to_parquet_indels.py \
      --input /home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.vcf.gz \
      --output /home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.indels.parquet \
      --bed /home/ubuntu/data/reference/beds/GRCh38_difficult_comp.bed.gz
Loading BED file: /home/ubuntu/data/reference/beds/GRCh38_difficult_comp.bed.gz
Loaded 4,750,502 regions
Processing VCF: /home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.vcf.gz
  Processed 100,000 variants, found 28,619 indels...
  Processed 200,000 variants, found 55,356 indels...
  Processed 300,000 variants, found 73,094 indels...
  Processed 400,000 variants, found 100,049 indels...
  Processed 500,000 variants, found 126,876 indels...
  Processed 600,000 variants, found 152,507 indels...
  Processed 700,000 variants, found 175,102 indels...
  Processed 800,000 variants, found 200,743 indels...
  Processed 900,000 variants, found 227,908 indels...
  Processed 1,000,000 variants, found 253,312 indels...
  Processed 1,100,000 variants, found 280,557 indels...
  Processed 1,200,000 variants, found 300,945 indels...
  Processed 1,300,000 variants, found 326,289 indels...
  Processed 1,400,000 variants, found 351,848 indels...
  Processed 1,500,000 variants, found 375,328 indels...
  Processed 1,600,000 variants, found 397,831 indels...
  Processed 1,700,000 variants, found 421,480 indels...
  Processed 1,800,000 variants, found 445,171 indels...
  Processed 1,900,000 variants, found 469,548 indels...
  Processed 2,000,000 variants, found 493,342 indels...
  Processed 2,100,000 variants, found 518,156 indels...
  Processed 2,200,000 variants, found 545,581 indels...
  Processed 2,300,000 variants, found 569,473 indels...
  Processed 2,400,000 variants, found 594,211 indels...
  Processed 2,500,000 variants, found 620,205 indels...
  Processed 2,600,000 variants, found 644,587 indels...
  Processed 2,700,000 variants, found 670,096 indels...
  Processed 2,800,000 variants, found 697,644 indels...
  Processed 2,900,000 variants, found 719,250 indels...
  Processed 3,000,000 variants, found 743,933 indels...
  Processed 3,100,000 variants, found 769,960 indels...
  Processed 3,200,000 variants, found 792,895 indels...
  Processed 3,300,000 variants, found 813,676 indels...
  Processed 3,400,000 variants, found 841,210 indels...
  Processed 3,500,000 variants, found 867,894 indels...
  Processed 3,600,000 variants, found 889,437 indels...
  Processed 3,700,000 variants, found 917,883 indels...
  Processed 3,800,000 variants, found 940,907 indels...
  Processed 3,900,000 variants, found 964,561 indels...
  Processed 4,000,000 variants, found 989,949 indels...
  Processed 4,100,000 variants, found 1,015,376 indels...
  Processed 4,200,000 variants, found 1,040,299 indels...
  Processed 4,300,000 variants, found 1,069,681 indels...
  Processed 4,400,000 variants, found 1,090,371 indels...
  Processed 4,500,000 variants, found 1,115,194 indels...
  Processed 4,600,000 variants, found 1,139,971 indels...
  Processed 4,700,000 variants, found 1,167,122 indels...
  Processed 4,800,000 variants, found 1,191,151 indels...
  Processed 4,900,000 variants, found 1,219,267 indels...
  Processed 5,000,000 variants, found 1,246,390 indels...
  Processed 5,100,000 variants, found 1,271,474 indels...
  Processed 5,200,000 variants, found 1,295,554 indels...
  Processed 5,300,000 variants, found 1,327,771 indels...
  Processed 5,400,000 variants, found 1,352,095 indels...
  Processed 5,500,000 variants, found 1,377,840 indels...
  Processed 5,600,000 variants, found 1,409,035 indels...
  Processed 5,700,000 variants, found 1,437,091 indels...
  Processed 5,800,000 variants, found 1,457,774 indels...
  Processed 5,900,000 variants, found 1,480,753 indels...
  Processed 6,000,000 variants, found 1,504,007 indels...
  Processed 6,100,000 variants, found 1,528,551 indels...
  Processed 6,200,000 variants, found 1,545,992 indels...

Processing complete:
  Total variants: 6,277,647
  Total indels: 1,557,716
  Multi-allelic sites: 84,968
  Mixed SNV/indel sites: 5,972
  Indels in not-difficult regions: 371,755 (23.9%)
  Indels in difficult regions: 1,185,961 (76.1%)
  Total indels in parquet: 1,557,716

Saving to parquet: /home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.indels.parquet

DataFrame summary:
  Shape: (1557716, 21)
  Chromosomes: 25
  Unique positions: 1479252

Indel type breakdown:
indel_type
deletion     976485
insertion    581231
Name: count, dtype: int64

Indel size distribution:
count    1.557716e+06
mean     3.237425e+00
std      8.087262e+00
min      1.000000e+00
25%      1.000000e+00
50%      1.000000e+00
75%      3.000000e+00
max      4.510000e+02
Name: indel_size, dtype: float64

Filter values:
filter
PASS       981985
RefCall    575731
Name: count, dtype: int64

Region annotation:
  In not-difficult regions: 371,755 (23.9%)
  In difficult regions: 1,185,961 (76.1%)

Conversion statistics:
  Conversions applied: 49,883 (3.2%)

  Breakdown of converted positions:
    With multiple indels: 49,883
    With mixed indel types: 23,287

  Example conversions (first 5):
    chr1:181583
      Original: REF=CGGGGG, ALT=CG
      Converted: REF=CGGGG, ALT=C
    chr1:791554
      Original: REF=GGAATGGAATC, ALT=GGAATCGAATGGAATC
      Converted: REF=G, ALT=GGAATC
    chr1:1020060
      Original: REF=GCC, ALT=GC
      Converted: REF=GC, ALT=G
    chr1:1035169
      Original: REF=TGG, ALT=TG
      Converted: REF=TG, ALT=T
    chr1:1102614
      Original: REF=TA, ALT=TAA
      Converted: REF=T, ALT=TA

Multi-indel positions:
  Positions with multiple indels: 77,327
  Positions with mixed ins/del: 22,965

Output saved to: /home/ubuntu/data/teamb_indel-caller/deep_variant/GTEx-sample1.indels.parquet